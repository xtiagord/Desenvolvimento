<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Subfolder</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <link rel="stylesheet" href="/pasta/csspasta.css">
</head>
<body>
    <header>
        <nav class="navbar navbar-dark bg-dark navbar-expand-lg">
            <a class="navbar-brand" href="#">
                <img src="/login/photo/untitled (1).png" width="30" height="30" class="d-inline-block align-top" alt="">
                Valmarc
              </a>
          <div class="collapse navbar-collapse">
            <ul class="navbar-nav mr-auto">
              <li class="nav-item">
                <a class="nav-link" href="/public/dashboard.html">Dashboard</a>
              </li>
              <li class="nav-item">
                <a class="nav-link  active" href="/public/pasta.html">Pastas</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/public/Cliente.html">Cooperados</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/Extrator.html">Lançamentos</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/public/Cadastro.html">Representante</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/public/ArchivePast.html">PDFs</a>
            </li>
            </ul>
            <div class="nav-item dropdown ml-auto">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Menu
              </a>
              <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                <a class="dropdown-item" href="#">Cadastro</a>
                <a class="dropdown-item" href="configuracao.html">Configurações</a>
              </div>
            </div>
          </div>
        </nav>
      </header>
    
    <div class="container mt-5">
        <h1>Criar Pastas</h1>
        <form id="create-folder-form">
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="date">Selecione a data:</label>
                    <input type="text" class="form-control" id="date" name="date" placeholder="DD/MM/YYYY" required>
                </div>
                <div class="form-group col-md-6">
                    <label for="mainFolder">Selecione o país:</label>
                    <select class="form-control" id="mainFolder" name="mainFolder">
                        <option value="ENTREGAS">BRASIL</option>
                        <option value="- PARAGUAI">PARAGUAI</option>
                        <option value="- BOLIVIA">BOLIVIA</option>
                    </select>
                </div>
            </div>
    
            <div class="form-row">
                <div class="form-group col-md-4">
                    <label for="baseFolder">Selecione nome do fornecedor:</label>
                    <select class="form-control" id="baseFolder" name="baseFolder" disabled>
                        <option value="- ADRIANO">- ADRIANO</option>
                        <option value="- ANDERSON">- ANDERSON</option>
                        <option value="- ARIEL">- ARIEL</option>
                        <option value="- CLAUDIO">- CLAUDIO</option>
                        <option value="- DEPOSITO">- DEPOSITO</option>
                        <option value="- DARIO">- DARIO</option>
                        <option value="- FREDY">- FREDY</option>
                        <option value="- IGOR">- IGOR</option>
                        <option value="- JOSE">- JOSE</option>
                        <option value="- LUCAS">- LUCAS</option>
                        <option value="- NELSON">- NELSON</option>
                    </select>
                </div>
                <div class="form-group col-md-4">
                    <label for="subFolderName">Nome do comprador:</label>
                    <input type="text" class="form-control" id="subFolderName" name="subFolderName" required>
                </div>
                <div class="form-group col-md-4">
                    <label for="directory">Diretorio de Destino:</label>
                    <input type="text" class="form-control" id="directory" name="directory" required>
                </div>
            </div>
    
            <div class="form-group">
                <label for="file">Upload da Foto:</label>
                <div id="dropzone" class="dropzone">
                    Selecione e arraste a foto ou clique aqui
                </div>
                <input type="file" class="form-control" id="file" name="file" style="display:none;">
                <img id="image-preview" src="" alt="Image Preview" style="display:none;">
            </div>
            <div class="form-group">
                <label for="newFileName">Nome da FOTO:</label>
                <input type="text" class="form-control" id="newFileName" name="newFileName" placeholder="New file name without extension" required>
            </div>
            <div class="form-group">
                <label for="pdfFile">Upload PDF (Opcional):</label>
                <div id="pdf-dropzone" class="dropzone">
                    Selecione e arraste o PDF ou clique aqui
                </div>
                <input type="file" class="form-control" id="pdfFile" name="pdfFile" accept=".pdf" style="display:none;">
                <span id="pdf-filename"></span>
            </div>
    
            <button type="submit" class="btn btn-primary">Criar Pasta</button>
        </form>
        <p id="result"></p>
        <div class="row mt-3">
            <div class="col">
                <button id="toggle-folders" class="btn btn-secondary">Mostrar 10 últimas pastas criadas</button>
            </div>
            <div class="col">
                <table class="table mt-3" id="folders-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Caminho</th>
                            <th>Data da criação</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Bootstrap JavaScript -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Bootstrap Datepicker JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script>
        $(document).ready(function() {
            $('#date').datepicker({
                format: 'dd/mm/yyyy',
                autoclose: true
            });

            // Manage main folder selection
            $('#mainFolder').change(function() {
                if ($(this).val() === 'ENTREGAS') {
                    $('#baseFolder').prop('disabled', true);
                } else {
                    $('#baseFolder').prop('disabled', false);
                }
            });

            let dropzone = document.getElementById('dropzone');
            let fileInput = document.getElementById('file');
            let imagePreview = document.getElementById('image-preview');

            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('dragover');
            });

            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('dragover');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                
                const file = e.dataTransfer.files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(event) { 
                        imagePreview.src = event.target.result;
                        imagePreview.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                } else {
                    alert('Please drop an image file.');
                }
                
                fileInput.files = e.dataTransfer.files;
                dropzone.textContent = file.name;
            });

            dropzone.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', () => {
                const file = fileInput.files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        imagePreview.src = event.target.result;
                        imagePreview.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                } else {
                    alert('Please select an image file.');
                }
                
                dropzone.textContent = file.name;
            });

            let pdfDropzone = document.getElementById('pdf-dropzone');
            let pdfFileInput = document.getElementById('pdfFile');
            let pdfFilename = document.getElementById('pdf-filename');

            pdfDropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                pdfDropzone.classList.add('dragover');
            });

            pdfDropzone.addEventListener('dragleave', () => {
                pdfDropzone.classList.remove('dragover');
            });

            pdfDropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                pdfDropzone.classList.remove('dragover');
                
                const file = e.dataTransfer.files[0];
                if (file.type === 'application/pdf') {
                    pdfFilename.textContent = file.name;
                } else {
                    alert('Please drop a PDF file.');
                }
                
                pdfFileInput.files = e.dataTransfer.files;
                pdfDropzone.textContent = file.name;
            });

            pdfDropzone.addEventListener('click', () => {
                pdfFileInput.click();
            });

            pdfFileInput.addEventListener('change', () => {
                const file = pdfFileInput.files[0];
                if (file.type === 'application/pdf') {
                    pdfFilename.textContent = file.name;
                } else {
                    alert('Please select a PDF file.');
                }
                
                pdfDropzone.textContent = file.name;
            });

            $('#create-folder-form').on('submit', function(event) {
                event.preventDefault();
                var formData = new FormData(this);

                $.ajax({
                    url: '/create-subfolder',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        $('#result').text(response);
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        $('#result').text('Error: ' + textStatus + ' - ' + errorThrown);
                    }
                });
            });

                    document.addEventListener('DOMContentLoaded', function() {
            var mainFolderSelect = document.getElementById('mainFolder');
            var baseFolderSelect = document.getElementById('baseFolder');

            mainFolderSelect.addEventListener('change', function() {
                var selectedCountry = mainFolderSelect.value;

                if (selectedCountry === '- PARAGUAI') {
                    disableOption(baseFolderSelect, '- DARIO');
                } else {
                    enableOption(baseFolderSelect, '- DARIO');
                }
            });

            function disableOption(selectElement, optionValue) {
                var options = selectElement.options;
                for (var i = 0; i < options.length; i++) {
                    if (options[i].value === optionValue) {
                        options[i].disabled = true;
                        break;
                    }
                }
            }

            function enableOption(selectElement, optionValue) {
                var options = selectElement.options;
                for (var i = 0; i < options.length; i++) {
                    if (options[i].value === optionValue) {
                        options[i].disabled = false;
                        break;
                    }
                }
            }

            var initialCountry = mainFolderSelect.value;
            if (initialCountry === '- PARAGUAI') {
                disableOption(baseFolderSelect, '- DARIO');
            }
        });

            $('#toggle-folders').on('click', function() {
                $('#folders-table').toggle();
                if ($('#folders-table').is(':visible')) {
                    $.get('/last-10-folders', function(data) {
                        let rows = '';
                        data.forEach(folder => {
                            rows += `<tr><td>${folder.path}</td><td>${folder.createdAt}</td></tr>`;
                        });
                        $('#folders-table tbody').html(rows);
                    });
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            var mainFolderSelect = document.getElementById('mainFolder');
            var baseFolderSelect = document.getElementById('baseFolder');

            mainFolderSelect.addEventListener('change', function() {
                var selectedCountry = mainFolderSelect.value;

                if (selectedCountry === '- PARAGUAI') {
                    disableOption(baseFolderSelect, '- DARIO');
                } else {
                    enableOption(baseFolderSelect, '- DARIO');
                }
                
            });

            function disableOption(selectElement, optionValue) {
                var options = selectElement.options;
                for (var i = 0; i < options.length; i++) {
                    if (options[i].value === optionValue) {
                        options[i].disabled = true;
                        break;
                    }
                }
            }

            function enableOption(selectElement, optionValue) {
                var options = selectElement.options;
                for (var i = 0; i < options.length; i++) {
                    if (options[i].value === optionValue) {
                        options[i].disabled = false;
                        break;
                    }
                }
            }
            var initialCountry = mainFolderSelect.value;
            if (initialCountry === '- PARAGUAI') {
                disableOption(baseFolderSelect, '- DARIO');
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            var mainFolderSelect = document.getElementById('mainFolder');
            var baseFolderSelect = document.getElementById('baseFolder');

            mainFolderSelect.addEventListener('change', function() {
                var selectedCountry = mainFolderSelect.value;

                if (selectedCountry === '- PARAGUAI') {
                    disableOption(baseFolderSelect, ['- DARIO']);
                } else if (selectedCountry === '- BOLIVIA') {
                    enableOption(baseFolderSelect, ['- DARIO']);
                } else {
                    disableOption(baseFolderSelect, ['- ADRIANO', '- ANDERSON', '- ARIEL', '- CLAUDIO', 
                                                    '- DEPOSITO', '- FREDY', '- IGOR', '- JOSE', '- LUCAS', '- NELSON']);
                }
                
            });

            function disableOption(selectElement, optionValues) {
                var options = selectElement.options;
                for (var i = 0; i < options.length; i++) {
                    if (optionValues.includes(options[i].value)) {
                        options[i].disabled = true;
                    }
                }
            }

            function enableOption(selectElement, optionValues) {
                var options = selectElement.options;
                for (var i = 0; i < options.length; i++) {
                    if (optionValues.includes(options[i].value)) {
                        options[i].disabled = false;
                    }
                }
            }
            var initialCountry = mainFolderSelect.value;
            if (initialCountry === '- PARAGUAI') {
                disableOption(baseFolderSelect, ['- DARIO']);
            } else if (initialCountry === '- BOLIVIA') {
                enableOption(baseFolderSelect, ['- DARIO']);
            }
        });
    </script>
</body>
</html>
